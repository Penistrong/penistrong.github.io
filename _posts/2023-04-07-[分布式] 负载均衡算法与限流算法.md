---
layout:     post
title:      "[分布式] 负载均衡算法与限流算法"
subtitle:   "常见负载均衡与限流算法"
author:     Penistrong
date:       2023-04-08 17:53:49 +0800
categories: distributed algorithm
catalog:    true
mathjax:    false
katex:      true
tags:
    - Distributed Algorithm
---

# 分布式系统负载均衡与限流算法

## 负载均衡算法

### 轮询法 Round Robin

将请求按顺序轮流分配到服务器上，它平等地对待服务集群的每一个实例，不关注实例实际的连接数和当前系统负载

### 加权轮询法 Weighted Round Robin

不同的实例其机器配置和当前系统负载并不相同，导致它们的抗压能力也不同。加权轮询法的思想就是给配置高、负载低的实例分配更高的权重，配置低、负载高的实例分配较低的权重，在轮询时按照权重将请求**顺序地**分配到服务实例上，能够很好缓解资源利用率不均衡的问题

“顺序”的含义是指，本质还是生成的一张轮询列表，但是服务实例按照其权重连续出现多次，以Nginx配置带权轮询为例:

```nginx
upstream backend {
   ip_hash;
   server 192.168.1.232 weight=4;
   server 192.168.1.233 weight=3;
   server 192.168.1.234 weight=1;
}
```

这样的话生成的带权轮询列表就是 `A,A,A,A,B,B,B,C`，这样的话按照普通轮询方法每一个请求就分配给轮询列表中的下一个实例即可，但是这样也会带来一个问题：权重大的服务实例一次性要接收大量请求

实际上Nginx中实现的带权轮询是平滑的，通过调整权重相同的重复实例在轮询列表中的位置，可以缓解上述问题，比如平滑后的带权轮询列表: `A,A,B,A,B,A,B,C`

### 随机法

通过系统的随机算法，从服务实例列表中随机选取一台服务器进行分配，由林德伯格大数统计理论，随着客户端请求被分配到不同服务端的次数增多，其实际效果也越来越接近轮询法中的调用量平均分配

### 加权随机法

与加权轮询法的思想类似，根据配置和负载分配不同的权重，但是请求是按照加权后**随机分配**，而不是像加权轮询法那样按照加权后的列表顺序分配的

同加权轮询法一样首先需要生成一张轮询列表，其中的服务实例按照其权重连续出现多次，计算权重总和后，利用随机数生成一个落在0~权重总和区间的随机权重，根据随机权重所在的区间选择对应服务实例即可

### 源地址哈希法

根据客户端的IP地址，通过哈希函数计算其哈希值，并使用除留余数法，对服务器列表大小取模，便可获得该客户端请求待分配的服务实例序号，这样的话当服务实例列表不变(没有实例下线或者新实例上线)时，同一源IP地址的请求每次都会映射到同一个服务实例处理

> 如果实例变动较为频繁，每次变动后都要更新实例列表，所以就引进了一致性哈希算法，对2^32取模(形似一个哈希环)，服务实例也是通过IP地址等取模安置在哈希环上，将请求的源IP地址对应的哈希取模后分配到最接近的服务实例上
>
> 当然这又会引出个问题，那就是服务实例的倾斜问题，当大部分服务实例密集地分配在哈希环的某段位置，一致性哈希算法的效果就会大打折扣，可以通过引入虚拟节点映射到实际服务实例的方式，均匀地分段整个哈希环

### 最小连接数法

## 限流算法

### 滑动窗口

### 令牌桶

### 漏桶
