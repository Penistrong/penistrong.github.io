---
layout:     post
title:      "科学研习英语"
subtitle:   "v2ray VPS VPN"
author:     Penistrong
date:       2019-09-30 19:59:08 +0800
header-img: "img/post-bg/2019-09-30-科学研习英语.jpg"
categories: misc
catalog: true
tags:
    - VPN
    - v2ray
---
@[TOC](如何研习英语)

## Catagory

- [Catagory](#catagory)
- [基础配置](#基础配置)
  - [首先要拥有一台VPS](#首先要拥有一台vps)
  - [服务端配置](#服务端配置)
  - [客户端配置](#客户端配置)
    - [配置V2rayN](#配置v2rayn)
    - [配置Chrome SwitchyOmega](#配置chrome-switchyomega)
  - [配置Linux客户端](#配置linux客户端)
  - [配置安卓客户端](#配置安卓客户端)
  - [配置iOS客户端](#配置ios客户端)
- [进阶配置](#进阶配置)
  - [安装BBR进行TCP加速](#安装bbr进行tcp加速)
  - [使用TLS+WebSocket+Nginx伪装网站流量](#使用tlswebsocketnginx伪装网站流量)
    - [申请域名并设置域名解析地址](#申请域名并设置域名解析地址)
    - [建站并配置TLS](#建站并配置tls)
    - [配置v2ray](#配置v2ray)
    - [配置Nginx](#配置nginx)
    - [客户端配置示例](#客户端配置示例)
  - [开启v2ray服务端流量监控](#开启v2ray服务端流量监控)
    - [开启API模块](#开启api模块)
    - [开启统计信息模块](#开启统计信息模块)
    - [配置文件总览](#配置文件总览)

---

## 基础配置

### 首先要拥有一台VPS

要研究英语自己有一台VPS是比较方便的路子。VPS就是虚拟专用服务器，这里我们用 [vultr](my.vultr.com) 的VPS，首先是注册账号，在选择机房前可以到 该网站 的支持页面 [测试各地服务器下载速度](https://www.vultr.com/resources/faq/#downloadspeedtests):

![服务器速度测试](https://img-blog.csdnimg.cn/20191026094252251.png)

一般新注册用户都有活动，可以免费试用这样子，也可以用Alipay, Wechat Pay~~蓝绿修改器~~(==2020年后vultr已移除Wechat Pay==):

![支付选项](https://img-blog.csdnimg.cn/20191026094627815.png)

![帐户余额](https://img-blog.csdnimg.cn/20191026094710357.png)

最后来到[选择VPS](https://my.vultr.com/deploy/)的页面购买你想要的套餐配置：
这里根据你上一步测试的各地服务器下载速度中挑一个速度比较快的，一般不推荐东京、洛杉矶等(IP被ban高发区)

![服务器地址](https://img-blog.csdnimg.cn/20191026095254212.png)

操作系统可以安装 centos 或者 ubuntu等，需要注意的是==centos==安装后**记得关闭防火墙**，**以免端口不开放**给我们要 学上科网 的客户端。套餐我们选择最便宜的那款，比如5刀/月(其实是按小时计价，可以随时停止服务器以节省资金，这通过快照实现，后文有讲)

![服务器系统类型](https://img-blog.csdnimg.cn/20191026095523168.png)

点击deploy后vultr就自动帮你安装VPS所用的操作系统了

![VPS构建中](https://img-blog.csdnimg.cn/20191026095640394.png)

点击CloudInstance进入配置页面

![服务器信息](https://img-blog.csdnimg.cn/20191026095804998.png)

这里可以看到服务器所在的IP地址和你创建的用户名及其自动生成的密码
用ssh远程连接上你的VPS

> ssh [username]@[IP]

以powershell为例

![powershell-ssh上服务器](https://img-blog.csdnimg.cn/20191026102410262.png)

如果是第一次ssh这个IP地址，PowerShell可能会提示你要不要将该地址加入knownhosts里

输入VPS创建时自动生成的密码后进入VPS

![ssh成功连接](https://img-blog.csdnimg.cn/20191026100230569.png)

建议更改密码，因为自动生成的密码通常又臭又长，更改密码请输入`passwd`，按提示更改即可

### 服务端配置

ssh远程连接后，使用自动安装v2ray脚本的方法, 输入以下命令
>bash <(curl -L -s <https://install.direct/go.sh>)

安装成功后使用
>cat /etc/v2ray/config.json

查看自动安装脚本为你生成的配置

![v2ray配置文件](https://img-blog.csdnimg.cn/20191026100717550.png)

上面的 端口(port)、UUID(id)、alterId需要记忆在你的客户端上，因为客户端需要这些参数以配置。
最后启动v2ray:
>systemctl start v2ray

使用诸如以下命令可管理服务状态
>systemctl status [service_name]
>systemctl stop [service_name]
>systemctl restart [service_name]

至此服务端的初步配置应该已经成功了

### 客户端配置

这里通过**v2rayN**(v2ray GUI版 管理工具)和Chrome的**SwitchyOmega**插件实现客户端配置(该配置实现Chrome浏览器自动代理上网，根据规则列表，对无墙网址不进行代理)

#### 配置V2rayN

在客户端（比如WIN10）
下载 [v2ray-core](https://github.com/v2ray/v2ray-core/releases)
下载 [v2rayN](https://github.com/2dust/v2rayN/releases)
v2rayN解压到v2ray-core的根目录里

![解压后文件夹示例](https://img-blog.csdnimg.cn/20191026101811368.png)

运行V2RayN.exe，然后进行配置。

客户端的配置需要根据你的服务端进行相应的配置，因为你的服务端协议可能是vmess,shadowsocks等。
我们在服务端使用自动脚本生成的配置默认有vmess协议，这里采用vmess:

![v2rayN新建配置](<https://img-blog.csdnimg.cn/20191026102012945.png>

将服务端配置里的**port, id, alterid**依此输入

![在这里插入图片描述](https://img-blog.csdnimg.cn/20191026102030403.png)
右击任务托盘里v2rayN的图片选择代理模式
![PAC代理](https://img-blog.csdnimg.cn/20191026102139930.png)

#### 配置Chrome SwitchyOmega

由于Chrome应用商店被墙，开启全局代理直接访问Chrome应用商店，搜索SwitchyOmega扩展安装即可
也可到GitHub上[下载该插件](https://github.com/FelisCatus/SwitchyOmega/releases)

![SwitchyOmega-Github-Release-Page](https://img-blog.csdnimg.cn/20191026102524558.png)

在本地解压crx文件，如果不能解压请将扩展名更改为zip或者rar等

在Chrome工具栏里找到 更多工具-扩展程序-加载已解压的扩展程序

![加载解压好的离线crx扩展](https://img-blog.csdnimg.cn/201910261028190.png)

选择刚刚解压出来的switchyOmega文件夹即可

接下来按步骤配置:

![设置代理服务器](https://img-blog.csdnimg.cn/20191026102849907.png)

![设置代理转发规则](https://img-blog.csdnimg.cn/20191026102903266.png)

![导入GFW规则列表](https://img-blog.csdnimg.cn/20191026102928780.png)

规则列表地址为 **<https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt>**

最后测试一下在Chrome中是否可以使用

![蓝P站](https://img-blog.csdnimg.cn/20191026103125243.png)

![脸书](https://img-blog.csdnimg.cn/20191026103201448.png)

如果你想使用全局代理，在代理模式那里选择全局即可

### 配置Linux客户端

使用**Qv2ray**，用相应的Linux发行版提供的包管理器自行下载Qv2ray即可，相关配置同v2rayN一致

- ArchLinux及其发行版，比如Manjaro

  ```shell
  sudo pacman -S qv2ray
  ```

- CentOS8，基于openSUSE

  ```shell
  cd /etc/yum.repos.d/
  wget https://download.opensuse.org/repositories/home:zzndb:Qv2ray/CentOS_8/home:zzndb:Qv2ray.repo
  yum install Qv2ray
  ```

- Debian及其发行版，比如Ubuntu

  ```shell
  # 添加GPG公钥
  curl https://qv2ray.net/debian/pubkey.gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/qv2ray-stable-archive.gpg
  # 添加qv2ray官方APT存储库
  echo "deb [arch=amd64] https://qv2ray.net/debian/ `lsb_releases -cs` main" | sudo tee /etc/apt/sources.list.d/qv2ray.list
  # 更新APT索引
  sudo apt update
  # 从APT安装Qv2ray
  sudo apt install qv2ray
  ```

### 配置安卓客户端

使用**BifrostV**或者**v2rayNG**，自行搜索下载，这里以BifrostV为例

![BiFrostV设置](https://img-blog.csdnimg.cn/2019102610462272.png)

输入你记录下来的**服务端v2ray配置v2ray.config里**的`host, port, id, alterid`

![配置示例](https://img-blog.csdnimg.cn/20191026104643517.png)

点击加速图标后即可在状态栏中显示VPN标识(需要给予开启VPN的权限)

![加速图标](https://img-blog.csdnimg.cn/20191026104953342.png)

### 配置iOS客户端

使用**Shadowrocket**或者**Kitsunebi**

注意这两款软件没有上架AppStore国区，可以自行注册外区iOS帐号登陆购买或者租用帐号进行下载

---

## 进阶配置

### 安装BBR进行TCP加速

可能你会烦恼VPN的速度还是不够快，可以安装**锐速**或者**BBR**进行TCP加速

输入以下命令，就能在centos/ubuntu/debian**服务器端**一键安装应用了google tcp-bbr加速算法的内核

```shell
wget –no-check-certificate <https://github.com/teddysun/across/raw/master/bbr.sh>
chmod +x bbr.sh
./bbr.sh
```

该脚本会自动升级服务器端的linux内核为BBR版，升级完成后会提示是否重启，重启即可采用新的内核

### 使用TLS+WebSocket+Nginx伪装网站流量

在实际使用中，原始的`ip:port`访问v2ray的方式很容易被GFW识别并对相应端口作出封禁，这十分影响科学探索

采用WebSocket作为传输协议，使用Nginx将服务端接收的数据包转发到v2ray本地监听地址，为了安全性起见，伪装网站采用HTTPS(HTTPS=HTTP+TLS/SSL)

#### 申请域名并设置域名解析地址

这一步按照个人需求办理，推荐选择以`.top`或`.xyz`等为顶级域名(~~图一个年租便宜~~)的域名

目前国内域名需要在相应的域名服务商那进行个人实名认证，比如在阿里云购买域名后如果想要使用阿里云的域名解析服务，就需要在阿里云用个人身份信息备案域名，注意==这一步可能需要3个工作日==

笔者认为可以将该域名重复利用，比如发布个人博客或者将一些Web项目挂在域名的子路径下，这样科学上网只不过是顺带一做罢了

域名申请完成后，记得要**设置域名解析**，将域名指向的IP地址解析到你的服务器地址上，这部分通常也在各大域名服务商那有相应的教程

以阿里云为例，购买阿里云提供的域名后，在`云解析DNS`的服务选项卡里设置域名解析

![设置域名解析](https://i.loli.net/2021/10/24/NlP4tuXbE8972mR.png)

#### 建站并配置TLS

建站根据你喜欢的方式来，这里只提供一个参考

如果你的服务器安装了**宝塔面板**，可以在面板侧边栏的网站选项中选择添加站点，填入域名和网站根目录(后者用于设置网站不同子路径下访问的对应目录)后即可建站

![宝塔面板建站](https://i.loli.net/2021/10/24/GgTRIPC4clEvbue.png)

建站完成后，点击运行中站点的设置，找到SSL选项，使用**Let's Encrypt**生成免费证书

宝塔面板自动生成的Nginx配置如下所示:

```nginx
server
{
    listen 80;
    listen 443 ssl http2;
    server_name www.penistrong.xyz;
    index index.php index.html index.htm default.php default.htm default.html;
    root /www/wwwroot/www.penistrong.xyz;
    
    #支持压缩的类型
    gzip_types text/plain application/x-javascript text/css text/javascript application/x-httpd-php application/json text/json image/jpeg image/gif image/png application/octet-stream;
    
    #SSL相关配置，请勿删除或修改下一行带注释的404规则
    #SSL-START 
    #error_page 404/404.html;
    ssl_certificate         /www/server/panel/vhost/cert/www.penistrong.xyz/fullchain.pem;
    ssl_certificate_key     /www/server/panel/vhost/cert/www.penistrong.xyz/privkey.pem;
    ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    add_header Strict-Transport-Security "max-age=31536000";
    error_page 497  https://$host$request_uri;

    #强制HTTPS
    #SSL-END
    
    location / {
      alias /www/wwwroot/www.penistrong.xyz/blog_site/;
      index index.html index.htm;
    }
    
    #ERROR-PAGE-START  错误页配置，可以注释、删除或修改
    error_page 404 /404.html;
    error_page 502 /502.html;
    #ERROR-PAGE-END
    
    #PHP-INFO-START  PHP引用配置，可以注释或修改
    include enable-php-00.conf;
    #PHP-INFO-END
    
    #REWRITE-START URL重写规则引用,修改后将导致面板设置的伪静态规则失效
    include /www/server/panel/vhost/rewrite/www.penistrong.xyz.conf;
    #REWRITE-END
    
    #禁止访问的文件或目录
    location ~ ^/(\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md)
    {
        return 404;
    }
    
    #一键申请SSL证书验证目录相关设置
    location ~ \.well-known{
        allow all;
    }
    
    access_log  /www/wwwlogs/www.penistrong.xyz.log;
    error_log  /www/wwwlogs/www.penistrong.xyz.error.log info;
}
```

#### 配置v2ray

域名和TLS已经有了，下一步轮到配置v2ray了

在v2ray的配置文件`config.json`的`inbounds`入站配置里的`InboundConfigurationObject`里添加streamSetting，并设置传输协议为WebSocket和其使用的子路径名，这里用`/ray`作为子路径，v2ray监听本地回环地址`localhost:port`，我的端口设置为12580，注意此项设置会使原来的`ip:port`格式使用的v2ray客户端服务无效，因为监听设置并没有使用"0.0.0.0"表示开放监听，该设置用于Nginx进行转发

```json
{
  "log":{
    "access": "/var/log/v2ray/access.log",
    "error": "/var/log/v2ray/error.log",
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "tag": "in-Main",
      "port": 12580,
      "listen": "127.0.0.1",
      "protocol": "vmess",
      "settings": {
        "clients": [...]
      },
      "streamSettings": {
        "network": "ws",
        "security": "auto",
        "wsSettings": {
          "path": "/ray",
          "headers": {
            "Host": "www.penistrong.xyz"
          }
        }
      }
    }
  ],
  "outbounds": [{
    "protocol": "freedom",
    "settings": {},
    "tag": "direct"
  },{
    "protocol": "blackhole",
    "settings": {},
    "tag": "blocked"
  }],
  "routing": {
    "domainStrategy": "AsIs",
    "rules": [
      {
        "type": "field",
        "ip": [
          "geoip:private"
        ],
        "outboundTag": "blocked"
      }
    ]
  }
}

```

然后重启v2ray

```shell
# 查看v2ray运行状态
systemctl status v2ray
# 重启v2ray，会重新载入配置文件
systemctl restart v2ray
```

#### 配置Nginx

v2ray已经开始监听发往服务端本机回环地址的端口的数据报，接下来要配置Nginx，设置WebSocket使用的子路径。

在前述使用的nginx配置文件中添加：

```nginx
server
{
  ...

  #v2ray WebSocket伪装的子路径
  location /ray {
    proxy_pass       http://127.0.0.1:12580;
    proxy_redirect             off;
    proxy_http_version         1.1;
    proxy_set_header Upgrade   $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host      $http_host;
  }

  ...
}
```

保证Nginx采用新的`nginx.conf`运行后，施工完毕

#### 客户端配置示例

施工之后，现在已经可以愉快地使用客户端享受v2ray服务了！

这里以**v2rayN**为例，给出新的==客户端配置文件示例==：

![v2rayN配置WebSocket示例](https://i.loli.net/2021/10/25/5gZvfzG4boKLBUO.png)

### 开启v2ray服务端流量监控

v2ray服务搭建好了，然后不可避免地想给好朋友用，但又想悄咪咪地看看朋友们在用v2ray访问了啥奇怪网站，所以可以开启v2ray的API模块+信息统计模块进行流量监控。

#### 开启API模块

v2ray的API基于`gRPC`，开启远程控制时，v2ray会自建一个出站代理，并对入站配置的`tag`值作为标识，用户需要把所有入站的gRPC连接通过`routing`指向该出栈代理。

开启API模块，需要在`config.json`里添加一个以`api`为名的对象`ApiObject`

```json
{
  ...
  "api": {
    "tag": "api",
    "service": [
      "HandlerService",
      "LoggerService",
      "StatsService"
    ]
  }
  ...
}
```

v2ray内建三种API服务，其中==StatsService==是我们的主要目标

|   API   |   用处  |
| :-----: | :-----: |
| HandlerService | 用于远程编辑出入站代理 |
| LoggerService | 暂时只支持内置Logger重启 |
| StatsService | 内置的数据统计服务，也是流量监控的主要模块 |

#### 开启统计信息模块

v2ray提供有关其运行状况的统计信息，为了开启该模块，首先需要在`config.json`里添加一个`StatsObject`来标记模块开关，并辅以`PolicyObject`配置其本地策略

```json
{
  ...
  "stats": {},
  "policy": {
    "levels": {
      "0": {
        "statsUserUplink": true,
        "statsUserDownlink": true
      },
      "1": {
        "statsUserUplink": true,
        "statsUserDownlink": true
      }
    },
    "system": {
      "statsInboundUplink": true,
      "statsInboundDownlink": true,
    }
  }
  ...
}
```

其中`levels`对应`map{string:LevelPolicyObject}`，键值对映射指明对不同string所表示的"level"级用户采取的本地策略
`LevelPolicyObject`支持的属性如下:

| 属性名 | 字段类型 | 意义 |
| :----: | :----: | :----: |
| handshake | number | 建立连接时的握手时间/s,default=`4`;握手阶段连接超时则中断 |
| connIdle | number | 连接空闲时间/s,default=`300`;超出`connIdle`时间后仍没数据传输，则终端该连接 |
| uplinkOnly | number | ==服务器==关闭下行连接后，等待`uplinkOnly`时间后中断连接/s,default=`2` |
| downlinkOnly| number | ==客户端==关闭上行连接后，等待`downlinkOnly`时间后中断连接/s,default=`5` |
| statsUserUplink | bool | 开启当前等级所有用户的上行流量统计 |
| statsUserDownlink | bool | 开启当前等级所有用户的下行流量统计 |
| bufferSize | number | 每个连接给予的内部缓存大小/kb;值为`0`时禁用内部缓存 |

`SystemPolicyObject`支持的属性如下:

| 属性名 | 字段类型 | 意义 |
| :----: | :----: | :----: |
| statsInboundUplink | bool | 开启所有入站代理的上行流量统计 |
| statsInboundDownlink | bool | 开启所有入站代理的下行流量统计 |

接着要给`clients`里为各个用户添加`email`信息，v2ray据此来分辨不同用户。同时，还要添加一个使用`dokodemo-door`协议的入站代理，标记其`tag=api`，与上一节的`ApiObject`相对应。该入站代理的`InboundObject`里的端口`port`用于API查询流量

```json
{
  "inbounds": [
    {
      ...
      "settings":{
        "clients":[
          ...
          {
            "email": "YourEmail@xxx.com",
            "id": "UUID",
            "level": 0,
            "alterId": 4
          }
          ...
        ]
      }
    },
    {
      "listen": "127.0.0.1",
      "port": 10085,
      "protocol": "dokodemo-door",
      "settings": {
          "address": "127.0.0.1"
      },
      "tag": "api"
    }
  ]
}
```

最后，在`routing`对应的`RoutingObject`里将出入站代理的标识(在这里都为`api`)进行路由绑定

```json
{
  ...
  "routing": {
    "settings": {
      "rules": [
        {
          "inboundTag": [
            "api"
          ],
          "outboundTag": "api",
          "type": "field"
        }
      ]
    },
    "strategy": "rules"
  }
  ...
}
```

至此，已经可以使用`v2ctl`命令进行流量查询

```shell
# 如果没有v2ctl，请到v2ray命令的同路径下找到v2ctl，以我的为例，其位于/usr/bin/v2ray/中
# 查看系统整体统计信息
v2ctl api --server=127.0.0.1:10085 StatsService.QueryStats 'pattern: "" reset: false'

# 查看特定用户的上行流量
v2ctl api --server=127.0.0.1:10085 StatsService.GetStats 'name: "user>>>YourEmail@xx.com>>>traffic>>>uplink" reset: false'

# 查看特定用户的下行信息
v2ctl api --server=127.0.0.1:10085 StatsService.GetStats 'name: "user>>>YourEmail@xx.com>>>traffic>>>downlink" reset: false'
```

==需要注意的是，一旦v2ray重启，前述流量统计信息都将丢失==

#### 配置文件总览

上面分阶段详细描述了配置过程，现给出一个简单的总配置文件示例以供参考

```json
{
  "api": {
    "tag": "api",
    "services": [
      "HandlerService",
      "LoggerService",
      "StatsService"
    ]
  },
  "stats":{},
  "policy":{
    "levels": {
      "0": {
        "statsUserUplink": true,
        "statsUserDownlink": true
      },
      "1": {
        "statsUserUplink": true,
        "statsUserDownlink": true
      }
    },
    "system": {
      "statsInboundUplink": true,
      "statsInboundDownlink": true
    }
  },
  "log":{
    "access": "/var/log/v2ray/access.log",
    "error": "/var/log/v2ray/error.log",
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "tag": "ws_tls",
      "port": 12580,
      "listen": "127.0.0.1",
      "protocol": "vmess",
      "settings": {
        "clients": [
          {
            "email": "OneEmail@xx.com",
            "id": "c4aa90d9-c3e7-4a65-b1d8-f6593cdf45b3",
            "level": 0,
            "alterId": 64
          },
          {
            "email": "AnotherEmail@xx.com",
            "id": "UUID",
            "level": 1,
            "alterId": 4
          }
        ]
      },
      "streamSettings": {
        "network": "ws",
        "security": "auto",
        "wsSettings": {
          "path": "/ogay",
          "headers": {
            "Host": "www.penistrong.xyz"
          }
        }
      }
    },
    {
      "listen": "127.0.0.1",
      "port": 10085,
      "protocol": "dokodemo-door",
      "settings": {
          "address": "127.0.0.1"
      },
      "tag": "api"
    }
  ],
  "outbounds": [{
    "protocol": "freedom",
    "settings": {},
    "tag": "freedom"
  },{
    "protocol": "blackhole",
    "settings": {},
    "tag": "blocked"
  }],
  "routing": {
    "settings": {
      "rules": [
        {
          "inboundTag": [
            "api"
          ],
          "outboundTag": "api",
          "type": "field"
        }
      ]
    },
    "strategy": "rules"
  }
}

```

---
