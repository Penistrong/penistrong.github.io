---
layout:     post
title:      "[Spring Cloud] 微服务架构组件特点"
subtitle:   "Nacos, Sentinel, Spring Cloud Gateway, RabbitMQ, etc."
author:     Penistrong
date:       2023-03-04 21:39:16 +0800
categories: jekyll update
catalog:    true
mathjax:    false
katex:      true
tags:
    - Java
    - Spring
    - Spring Cloud
---

# Spring Cloud 微服务架构常用组件特点

## Sentinel

大型微服务系统中高可用性的重要一环便是 **服务容错**。

高可用性保障的一种常规操作是通过搭建分布式服务集群以避免单点故障，但是在面对 **服务雪崩** 时仍不具备保障。服务集群中总会存在部分服务，其底层需要对数据库等数据源进行数据读写，假设它需要执行一段性能没有优化的SQL语句，这样的话单次DB操作的执行时间会稍长，在并发量较小的情况下通常不会存在问题，一旦并发量井喷，这种性能上的些微差距就会被迅速放大

这种情况下，该服务会迅速消耗数据库的连接资源，进而导致该服务提供接口的响应时间不断延长，而上级服务的请求又在源源不断地抵达该服务，这样接口超时就会如雪崩一般毁灭性地滚向上级服务，再淹没更上级的服务，导致整个服务集群不可用。

*Sentinel*就是一款能够应对服务雪崩的服务容错组件，它按照"内外兼修"的思路消弭服务雪崩，犹如前线的**哨兵**一样:

### 内部异常治理

Sentinel采取 **降级** 与 **熔断** 的方式处理服务集群内部出现的异常:

- 降级: 当服务调用发生响应超时、服务异常等情况时，可以转而执行**降级逻辑**，比如重试请求、恢复异常、默认返回等，降级是针对**单次**服务调用异常而执行的处理逻辑

- 熔断: 当服务异常积累到一定阈值时，比如某段时间窗口内降级请求出现了一定次数，则Sentinel会让该发起调用的微服务在一段时间内停止向目标服务发起调用，所有相关请求直接执行降级逻辑。所以熔断是**多次**服务调用异常而执行的处理逻辑

### 外部流量控制

Sentinel可以通过流量整形、流量控制等方案，为每个微服务设置规则，从QPS或并发请求线程数等维度控制外界来访流量。一旦访问量超过阈值，Sentinel可以采取多重手段处理后续到达的请求:

- 快速失败 Fast Fail: 直接丢弃请求，抛出异常`Blocked by Sentinel(flow limiting)`

- 预热模型 Warm Up: 在一段规定的预热时间窗口内，由低到高逐渐拉高流量阈值，直到预设的最高阈值位置

- 排队模型: 将后续的服务请求放入缓冲队列，如果该请求在预设的超时时间内仍未被处理，则将其移出队列丢弃
